<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Mozilla InvestiGator Cheat Sheet</title>
<meta name="author" content="Guillaume Destuynder &lt;kang&#64;mozilla.com&gt;" />
<style type="text/css">

body {
  width: 95%;
  max-width: 900px;
  margin: 20px;
  padding: 0;
  background: #151515 url("../images/bkg.png") 0 0;
  color: #eaeaea;
  font: 16px;
  line-height: 1.5;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
}

/* General & 'Reset' Stuff */

.container {
  width: 95%;
  max-width: 1000px;
  margin: 0 auto;
}

section {
  display: block;
  margin: 0 0 20px 0;
}

h1, h2, h3, h4, h5, h6 {
  /*margin: 0 0 20px;*/
  margin: 0;
}

li {
  line-height: 1.4 ;
}

/* Header, <header>
 *    header   - container
 *       h1       - project name
 *          h2       - project description
 *          */

header {
  background: rgba(0, 0, 0, 0.1);
  width: 100%;
  border-bottom: 1px dashed #b5e853;
  /*padding: 20px 0;
 *   margin: 0 0 40px 0;*/
  padding: 5px 0;
  margin: 0 0 10px 0;
}

header h1 {
  font-size: 30px;
  line-height: 1.5;
  margin: 0 0 0 -40px;
  font-weight: bold;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  /*color: #b5e853;*/
  color: #089d00;
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1),
               0 0 5px rgba(181, 232, 83, 0.1),
               0 0 10px rgba(181, 232, 83, 0.1);
  letter-spacing: -1px;
  -webkit-font-smoothing: antialiased;
}

header h1:before {
  content: "./ ";
  font-size: 24px;
}

header h2 {
  font-size: 18px;
  font-weight: 300;
  /*color: #666;*/
  color: #ff7800;
}

/* Main Content
 * */

#main_content {
  width: 100%;
  -webkit-font-smoothing: antialiased;
}
section img {
  max-width: 100%
}

h1, h2, h3, h4, h5, h6 {
  font-weight: normal;
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  /*color: #b5e853;*/
  color: #8AB638;
  letter-spacing: -0.03em;
  /*text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1),
               0 0 5px rgba(181, 232, 83, 0.1),
               0 0 10px rgba(181, 232, 83, 0.1);*/
}

#main_content h1 {
  font-size: 30px;
}

#main_content h2 {
  font-size: 24px;
}

#main_content h3 {
  font-size: 18px;
}

#main_content h4 {
  font-size: 14px;
}

#main_content h5 {
  font-size: 12px;
  text-transform: uppercase;
  margin: 0 0 5px 0;
}

#main_content h6 {
  font-size: 12px;
  text-transform: uppercase;
  color: #999;
  margin: 0 0 5px 0;
}

dt {
  font-style: italic;
  font-weight: bold;
}
/*
ul li {
  list-style: none;
}
*/
/*
ul li:before {
  content: ">>";
  font-family: Monaco, "Bitstream Vera Sans Mono", "Lucida Console", Terminal, monospace;
  font-size: 13px;
  color: #b5e853;
  margin-left: -37px;
  margin-right: 21px;
  line-height: 16px;
}
*/

blockquote {
  color: #aaa;
  padding-left: 10px;
  border-left: 1px dotted #666;
}


pre {
  background: rgba(0, 0, 0, 0.9);
  border: 1px solid rgba(255, 255, 255, 0.15);
  padding: 10px;
  font-size: 14px;
  //color: #b5e853;
  border-radius: 2px;
  -moz-border-radius: 2px;
  -webkit-border-radius: 2px;
  text-wrap: normal;
  overflow: auto;
  overflow-y: hidden;
}

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
//pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment, code .c1 { color: #FF7428; }
code, pre.code .keyword, code .keyword, pre.code .kd, pre.code .kn, pre.code .k, pre.code .o { color: #00a5ff; font-weight: bold;}
pre.code .nb { color: #c45918;}
pre.code .s {color: #0a77c4;}
pre.code .punctuation, pre.code .punctuation, pre.code .p { color: white;}
pre.code .literal.string, pre.code .literal.string { color: #40BF32; }
pre.code .name.builtin, pre.code .name.builtin, pre.code .nx { color: white; }
pre.code .deleted, pre.code .deleted { background-color: #DEB0A1}
pre.code .inserted, pre.code .inserted { background-color: #A3D289}

table {
  width: 100%;
  margin: 0 0 20px 0;
}

th {
  text-align: left;
  border-bottom: 1px dashed #b5e853;
  padding: 5px 10px;
}

td {
  padding: 5px 10px;
}

hr {
  height: 0;
  border: 0;
  border-bottom: 1px dashed #b5e853;
  color: #b5e853;
}
/* Links
 *    a, a:hover, a:visited
 *    */

a {
  color: #63c0f5;
  text-shadow: 0 0 5px rgba(104, 182, 255, 0.5);
}

cite {
  color: #00FF4A;
}

strong {
  color: #C64216;
}

</style>
</head>
<body>
<div class="document" id="mozilla-investigator-cheat-sheet">
<h1 class="title">Mozilla InvestiGator Cheat Sheet</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Guillaume Destuynder &lt;<a class="reference external" href="mailto:kang&#64;mozilla.com">kang&#64;mozilla.com</a>&gt;</td></tr>
</tbody>
</table>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="auto-toc simple">
<li><a class="reference internal" href="#file-module" id="id1">1&nbsp;&nbsp;&nbsp;File module</a><ul class="auto-toc">
<li><a class="reference internal" href="#find-files-in-etc-cron-d-that-contain-mysql-on-hosts-buildbot" id="id2">1.1&nbsp;&nbsp;&nbsp;Find files in /etc/cron.d that contain &quot;mysql://&quot; on hosts &quot;<em>buildbot</em>&quot;</a></li>
<li><a class="reference internal" href="#find-files-etc-passwd-that-have-been-modified-in-the-past-2-days" id="id3">1.2&nbsp;&nbsp;&nbsp;Find files /etc/passwd that have been modified in the past 2 days</a></li>
<li><a class="reference internal" href="#find-endpoints-with-high-uptime" id="id4">1.3&nbsp;&nbsp;&nbsp;Find endpoints with high uptime</a></li>
<li><a class="reference internal" href="#find-endpoints-running-process-sbin-auditd" id="id5">1.4&nbsp;&nbsp;&nbsp;Find endpoints running process &quot;/sbin/auditd&quot;</a></li>
<li><a class="reference internal" href="#find-which-machines-have-a-specific-usb-device-connected" id="id6">1.5&nbsp;&nbsp;&nbsp;Find which machines have a specific USB device connected</a></li>
</ul>
</li>
<li><a class="reference internal" href="#netstat-module" id="id7">2&nbsp;&nbsp;&nbsp;Netstat module</a><ul class="auto-toc">
<li><a class="reference internal" href="#searching-for-a-fraudulent-ip" id="id8">2.1&nbsp;&nbsp;&nbsp;Searching for a fraudulent IP</a></li>
<li><a class="reference internal" href="#locating-a-device-by-its-mac-address" id="id9">2.2&nbsp;&nbsp;&nbsp;Locating a device by its mac address</a></li>
<li><a class="reference internal" href="#listing-endpoints-that-have-active-connections-to-the-internet" id="id10">2.3&nbsp;&nbsp;&nbsp;Listing endpoints that have active connections to the Internet</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ping-module" id="id11">3&nbsp;&nbsp;&nbsp;Ping module</a><ul class="auto-toc">
<li><a class="reference internal" href="#test-web-connectivity-to-google" id="id12">3.1&nbsp;&nbsp;&nbsp;Test web connectivity to google</a></li>
<li><a class="reference internal" href="#list-endpoints-that-cannot-ping-a-destination" id="id13">3.2&nbsp;&nbsp;&nbsp;List endpoints that cannot ping a destination</a></li>
</ul>
</li>
<li><a class="reference internal" href="#timedrift-module" id="id14">4&nbsp;&nbsp;&nbsp;Timedrift module</a></li>
<li><a class="reference internal" href="#advanced-targetting" id="id15">5&nbsp;&nbsp;&nbsp;Advanced targetting</a><ul class="auto-toc">
<li><a class="reference internal" href="#target-agents-that-found-results-in-a-previous-action" id="id16">5.1&nbsp;&nbsp;&nbsp;Target agents that found results in a previous action</a></li>
</ul>
</li>
</ul>
</div>
<p>This is a list of common operations you may want to run with MIG.</p>
<div class="section" id="file-module">
<h1><a class="toc-backref" href="#id1">1&nbsp;&nbsp;&nbsp;File module</a></h1>
<p>You can find detailled documentation by running <cite>mig file help</cite> or in the
online doc at <cite>doc/module_file.html</cite>.</p>
<div class="section" id="find-files-in-etc-cron-d-that-contain-mysql-on-hosts-buildbot">
<h2><a class="toc-backref" href="#id2">1.1&nbsp;&nbsp;&nbsp;Find files in /etc/cron.d that contain &quot;mysql://&quot; on hosts &quot;<em>buildbot</em>&quot;</a></h2>
<p>This is a simple file content check that looks into all the files contained in
<cite>/etc/cron.d</cite> for a string that matched <cite>mysql://</cite>.</p>
<pre class="code bash literal-block">
mig file -t <span class="literal string double">&quot;environment-&gt;&gt;'os'='linux' AND name LIKE '%buildbot%'&quot;</span> -path /etc/cron.d/ -content <span class="literal string double">&quot;mysql://&quot;</span>
</pre>
</div>
<div class="section" id="find-files-etc-passwd-that-have-been-modified-in-the-past-2-days">
<h2><a class="toc-backref" href="#id3">1.2&nbsp;&nbsp;&nbsp;Find files /etc/passwd that have been modified in the past 2 days</a></h2>
<p>The <cite>mtime</cite> check of the file module matches against the last modified
timestamp of a file.</p>
<pre class="code bash literal-block">
mig file -t <span class="literal string double">&quot;environment-&gt;&gt;'os'='linux'&quot;</span> -path /etc/passwd -mtime &lt;2d
</pre>
</div>
<div class="section" id="find-endpoints-with-high-uptime">
<h2><a class="toc-backref" href="#id4">1.3&nbsp;&nbsp;&nbsp;Find endpoints with high uptime</a></h2>
<p>On Linux and MacOS, the uptime of a host is kept in <cite>/proc/uptime</cite>. We can
apply a regex on that file to list hosts with an uptime larger or lower than
any amount.</p>
<p>Note the search target that uses postgres's regex format <cite>~*</cite>.</p>
<pre class="code bash literal-block">
mig file -t <span class="literal string double">&quot;environment-&gt;&gt;'os' IN ('linux', 'darwin')&quot;</span> -path /proc/uptime -content <span class="literal string double">&quot;^[5-9]{1}[0-9]{7,}\\.&quot;</span>
</pre>
</div>
<div class="section" id="find-endpoints-running-process-sbin-auditd">
<h2><a class="toc-backref" href="#id5">1.4&nbsp;&nbsp;&nbsp;Find endpoints running process &quot;/sbin/auditd&quot;</a></h2>
<p>Here, the '^' in the content regex is important to prevent mig from listing
itself while searching for the command line.</p>
<pre class="code bash literal-block">
mig file -path /proc/ -name cmdline -content <span class="literal string double">&quot;^/sbin/auditd&quot;</span>
</pre>
<p>Another option, if using '^' is not possible, is to enclose one of the letter
of the process name into brackets:</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>mig file -t <span class="literal string double">&quot;tags-&gt;&gt;'operator'='IT'&quot;</span> -path /proc -name <span class="literal string double">&quot;^cmdline</span><span class="name variable">$&quot;</span><span class="literal string double"> -maxdepth 2 -content &quot;</span><span class="operator">[</span>a<span class="operator">]</span>rcsight<span class="literal string double">&quot;</span>
</pre>
</div>
<div class="section" id="find-which-machines-have-a-specific-usb-device-connected">
<h2><a class="toc-backref" href="#id6">1.5&nbsp;&nbsp;&nbsp;Find which machines have a specific USB device connected</a></h2>
<p>In this example, we'll look for the CryptoStick USB device (vendor:product 20a0:4107).
You can find more device id's with the command <cite>lsusb</cite>.</p>
<pre class="code bash literal-block">
mig file -matchany -path /sys/devices/ -name <span class="literal string double">&quot;^uevent</span><span class="name variable">$&quot;</span><span class="literal string double"> -content &quot;</span><span class="name variable">PRODUCT</span><span class="operator">=</span>20a0/4107<span class="literal string double">&quot;</span>
</pre>
</div>
</div>
<div class="section" id="netstat-module">
<h1><a class="toc-backref" href="#id7">2&nbsp;&nbsp;&nbsp;Netstat module</a></h1>
<p>You can find detailled documentation by running <cite>mig netstat help</cite>.</p>
<div class="section" id="searching-for-a-fraudulent-ip">
<h2><a class="toc-backref" href="#id8">2.1&nbsp;&nbsp;&nbsp;Searching for a fraudulent IP</a></h2>
<p>Given an ip 1.2.3.4 associated with fraudulent traffic, we can use the netstat
module to verify that the IP isn't currently connected to any endpoint.</p>
<pre class="code bash literal-block">
mig netstat -ci 1.2.3.4
</pre>
<p><cite>-ci</cite> stands for connected IP, and accepts an IP or a CIDR, in v4 or v6.</p>
</div>
<div class="section" id="locating-a-device-by-its-mac-address">
<h2><a class="toc-backref" href="#id9">2.2&nbsp;&nbsp;&nbsp;Locating a device by its mac address</a></h2>
<p>MIG <cite>netstat</cite> can be used to find endpoints that have a given mac address in
their arp tables, which helps geographically locating an endpoint.</p>
<pre class="code bash literal-block">
mig netstat -nm 8c:70:5a:c8:be:50
</pre>
<p><cite>-nm</cite> stands for neighbor mac and takes a regex (ex: <cite>^8c:70:[0-9a-f]</cite>).</p>
</div>
<div class="section" id="listing-endpoints-that-have-active-connections-to-the-internet">
<h2><a class="toc-backref" href="#id10">2.3&nbsp;&nbsp;&nbsp;Listing endpoints that have active connections to the Internet</a></h2>
<p>The search below tells the <cite>netstat</cite> module to capture all connections with one
IP in a public CIDR. The list of CIDR is rather long, because it avoid private
CIDR (the netstat module doesn't have an <cite>exclude</cite> option).</p>
<pre class="code bash literal-block">
mig netstat -e 60s      -ci 1.0.0.0/8           -ci 2.0.0.0/7           -ci 4.0.0.0/6   -ci 8.0.0.0/7 <span class="literal string escape">\
</span>-ci 11.0.0.0/8          -ci 12.0.0.0/6          -ci 16.0.0.0/4          -ci 32.0.0.0/3  -ci 64.0.0.0/3 <span class="literal string escape">\
</span>-ci 96.0.0.0/4          -ci 112.0.0.0/5         -ci 120.0.0.0/6         -ci 124.0.0.0/7 -ci 126.0.0.0/8 <span class="literal string escape">\
</span>-ci 128.0.0.0/3         -ci 160.0.0.0/5         -ci 168.0.0.0/6         -ci 172.0.0.0/12 <span class="literal string escape">\
</span>-ci 172.32.0.0/11       -ci 172.64.0.0/10       -ci 172.128.0.0/9       -ci 173.0.0.0/8 <span class="literal string escape">\
</span>-ci 174.0.0.0/7         -ci 176.0.0.0/4         -ci 192.0.0.0/9         -ci 192.128.0.0/11 <span class="literal string escape">\
</span>-ci 192.160.0.0/13      -ci 192.169.0.0/16      -ci 192.170.0.0/15      -ci 192.172.0.0/14 <span class="literal string escape">\
</span>-ci 192.176.0.0/12      -ci 192.192.0.0/10      -ci 193.0.0.0/8         -ci 194.0.0.0/7 <span class="literal string escape">\
</span>-ci 196.0.0.0/6         -ci 200.0.0.0/5         -ci 208.0.0.0/4
</pre>
</div>
</div>
<div class="section" id="ping-module">
<h1><a class="toc-backref" href="#id11">3&nbsp;&nbsp;&nbsp;Ping module</a></h1>
<div class="section" id="test-web-connectivity-to-google">
<h2><a class="toc-backref" href="#id12">3.1&nbsp;&nbsp;&nbsp;Test web connectivity to google</a></h2>
<p>Testing reachability of google.com over HTTP can be done using the ping module.</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>mig ping -t <span class="literal string double">&quot;name LIKE '%phx1%'&quot;</span> -d google.com -dp <span class="literal number">80</span> -p tcp
</pre>
</div>
<div class="section" id="list-endpoints-that-cannot-ping-a-destination">
<h2><a class="toc-backref" href="#id13">3.2&nbsp;&nbsp;&nbsp;List endpoints that cannot ping a destination</a></h2>
<p>Need to find which endpoints cannot connect to some destination? ICMP Ping is a
pretty good way to get that data. Make sure to adapt the <cite>show</cite> parameter to
list endpoints that have failed the ping.</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>mig ping -t <span class="literal string double">&quot;name LIKE '%scl3%'&quot;</span> -show notfound -d 10.22.75.57 -p icmp
</pre>
</div>
</div>
<div class="section" id="timedrift-module">
<h1><a class="toc-backref" href="#id14">4&nbsp;&nbsp;&nbsp;Timedrift module</a></h1>
<p>The timedrift module is fairly basic: it retrieves localtime and compares it to
NTP time if asked to check for drift. As such, it only takes a single parameter
to evaluate drift from network time.</p>
<pre class="code bash literal-block">
<span class="name variable">$ </span>mig timedrift -drift 60s
<span class="literal number">1402</span> agents will be targeted. ctrl+c to cancel. launching in <span class="literal number">5</span> <span class="literal number">4</span> <span class="literal number">3</span> <span class="literal number">2</span> <span class="literal number">1</span> GO
Following action ID 1428420741979034880.
<span class="name variable">status</span><span class="operator">=</span>inflight...55% ...66% ...67% ......89% ..89% ...89% ......90% ..90% ......90% ...90% ..90% ...^Cstop following action. agents may still be running. printing available results:
host1.dc2.example.net <span class="name builtin">local time </span>is 2015-04-07T15:35:00.768951216Z
host1.dc2.example.net <span class="name builtin">local time </span>is out of sync from NTP servers
host1.dc2.example.net Local <span class="name builtin">time </span>is ahead of ntp host time.nist.gov by 3m2.660981781s
<span class="literal number">1</span> agents have found results
</pre>
</div>
<div class="section" id="advanced-targetting">
<h1><a class="toc-backref" href="#id15">5&nbsp;&nbsp;&nbsp;Advanced targetting</a></h1>
<p>MIG can use complex queries to target specific agents. The following examples
outline some of the capabilities. At the core, the <cite>target</cite> parameter is just a
WHERE condition executed against the agent table of the MIG database, so if you
know the DB schema, you can craft any targetting you want.</p>
<div class="section" id="target-agents-that-found-results-in-a-previous-action">
<h2><a class="toc-backref" href="#id16">5.1&nbsp;&nbsp;&nbsp;Target agents that found results in a previous action</a></h2>
<p>Useful to run a second action on the agents that returned positive results in a
first one. The query is a bit complex because it uses Postgres JSON array
processing.</p>
<p>Given an action with ID 12345 that was run and returned results, we want to run
a new action on the agents that matched action 12345. To do so, use the target
that follows:</p>
<pre class="code bash literal-block">
mig file -t <span class="literal string double">&quot;id IN ( \
        SELECT agentid FROM commands, json_array_elements(commands.results) AS r \
        WHERE commands.actionid = 12345 AND r#&gt;&gt;'{foundanything}' = 'true')&quot;</span> <span class="literal string escape">\
</span>-path /etc/passwd -content <span class="literal string double">&quot;^spongebob&quot;</span>
</pre>
<p>The subquery select command results for action 12345 and return the ID of
agents that have at least one <cite>foundanything</cite> set to true. Since command
results are an array, and each entry of the array contains a foundanything
value, the query iterates through each entry of the array using postgres's
<cite>json_array_elements</cite> function.</p>
</div>
</div>
</div>
</body>
</html>
