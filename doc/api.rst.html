<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link href="docstyle.css" rel="stylesheet" />
    <title>MIG API</title>
    <meta content="Julien Vehent &lt;jvehent@mozilla.com&gt;" name="author" />
</head>
<body>
    <h1>MIG API</h1>
    <aside class="topic contents" id="table-of-contents">
        <h1>Table of Contents</h1>
        <ul class="auto-toc">
            <li>
                <p><a href="#api-endpoints">1   API endpoints</a></p>
                <ul class="auto-toc">
                    <li><a href="#get-dashboard">1.1   GET /dashboard</a></li>
                    <li><a href="#get-action">1.2   GET /action</a></li>
                    <li><a href="#post-action-create">1.3   POST /action/create/</a></li>
                    <li><a href="#get-agent">1.4   GET /agent</a></li>
                    <li><a href="#get-command">1.5   GET /command</a></li>
                    <li><a href="#get-investigator">1.6   GET /investigator</a></li>
                    <li><a href="#post-investigator-create">1.7   POST /investigator/create/</a></li>
                    <li><a href="#post-investigator-update">1.8   POST /investigator/update/</a></li>
                    <li><a href="#get-search">1.9   GET /search</a></li>
                </ul>
            </li>
            <li>
                <p><a href="#data-transformation">2   Data transformation</a></p>
                <ul class="auto-toc">
                    <li><a href="#compliance-items">2.1   Compliance Items</a></li>
                </ul>
            </li>
        </ul>
    </aside>
    <p>Interactions between an investigator (a human being) and the MIG platform are performed through a REST API. The API exposes functions to create actions, retrieve results, and generally monitor the activity of the agents.</p>
    <p>The API follows the core principles of REST, and provides discoverable endpoints. The document format follows the <a href="http://amundsen.com/media-types/collection/">Collection+JSON - Hypermedia Type</a>.</p>
    <section id="api-endpoints">
        <h2>1   API endpoints</h2>
        <p>The API root is at <cite>/api/v1</cite>. All the endpoints described below are reachable behind the root.</p>
        <section id="get-dashboard">
            <h3>1.1   GET /dashboard</h3>
            <ul>
                <li>Description: display a status dashboard of the MIG platform and agents</li>
                <li>Parameters: none</li>
                <li>Example:</li>
            </ul>
            <pre><code class="bash">/api/v1/dashboard</code></pre>
        </section>
        <section id="get-action">
            <h3>1.2   GET /action</h3>
            <ul>
                <li>Description: retrieve an action by its ID. Include links to related commands.</li>
                <li>
                    <dl>
                        <dt>Parameters:</dt>
                        <dd>
                            <ul>
                                <li><cite>actionid</cite>: a uint64 that identifies an action by its ID</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
                <li>Example:</li>
            </ul>
            <pre><code class="bash">/api/v1/action?actionid<span class="o">=</span>6019232215298562584</code></pre>
        </section>
        <section id="post-action-create">
            <h3>1.3   POST /action/create/</h3>
            <ul>
                <li>Description: send a signed action to the API for submission to the scheduler.</li>
                <li>
                    <dl>
                        <dt>Parameters: (POST body)</dt>
                        <dd>
                            <ul>
                                <li><cite>action</cite>: a signed action in JSON format</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
                <li>Example: (posting using mig-action-generator)</li>
            </ul>
            <pre><code class="bash">./bin/linux/amd64/mig-action-generator -i examples/actions/linux-backdoor.json -k jvehent@mozilla.com -posturl<span class="o">=</span>http://localhost:1664/api/v1/action/create/</code></pre>
        </section>
        <section id="get-agent">
            <h3>1.4   GET /agent</h3>
            <ul>
                <li>Description: retrieve an agent by its ID</li>
                <li>
                    <dl>
                        <dt>Parameters:</dt>
                        <dd>
                            <ul>
                                <li><cite>agentid</cite>: a uint64 that identifies an agent by its ID</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
                <li>Example:</li>
            </ul>
            <pre><code class="bash">/api/v1/agent?agentid<span class="o">=</span>6074883012002259968</code></pre>
        </section>
        <section id="get-command">
            <h3>1.5   GET /command</h3>
            <ul>
                <li>Description: retrieve a command by its ID. Include link to related action.</li>
                <li>
                    <dl>
                        <dt>Parameters:</dt>
                        <dd>
                            <ul>
                                <li><cite>commandid</cite>: a uint64 that identifies a command by its ID</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
                <li>Example:</li>
            </ul>
            <pre><code class="bash">/api/v1/command?commandid<span class="o">=</span>6019232259520546404</code></pre>
        </section>
        <section id="get-investigator">
            <h3>1.6   GET /investigator</h3>
            <ul>
                <li>Description: retrieve an investigator by its ID. Include link to the investigator's action history.</li>
                <li>
                    <dl>
                        <dt>Parameters:</dt>
                        <dd>
                            <ul>
                                <li><cite>investigatorid</cite>: a uint64 that identifies a command by its ID</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
                <li>Example:</li>
            </ul>
            <pre><code class="bash">/api/v1/investigator?investigatorid<span class="o">=</span>1</code></pre>
        </section>
        <section id="post-investigator-create">
            <h3>1.7   POST /investigator/create/</h3>
            <ul>
                <li>Description: create a new investigator in the database</li>
                <li>
                    <dl>
                        <dt>Parameters: (POST body)</dt>
                        <dd>
                            <ul>
                                <li><cite>name</cite>: string that represents the full name</li>
                                <li><cite>publickey</cite>: armored GPG public key</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
                <li>Example:</li>
            </ul>
            <pre><code class="bash"><span class="nv">$ </span>gpg --export -a --export-options <span class="nb">export</span>-minimal bob_kelso@example.net &gt; /tmp/bobpubkey

<span class="nv">$ </span>curl -iv -F <span class="s2">"name=Bob Kelso"</span> -F <span class="nv">publickey</span><span class="o">=</span>@/tmp/pubkey
http://localhost:1664/api/v1/investigator/create/</code></pre>
        </section>
        <section id="post-investigator-update">
            <h3>1.8   POST /investigator/update/</h3>
            <ul>
                <li>Description: update an existing investigator in the database</li>
                <li>
                    <dl>
                        <dt>Parameters: (PUT body)</dt>
                        <dd>
                            <ul>
                                <li><cite>id</cite>: investigator id, to identify the target investigator</li>
                                <li><cite>status</cite>: new status of the investigator, to be updated</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
                <li>Example:</li>
            </ul>
            <pre><code class="bash"><span class="nv">$ </span>curl -iv -X POST -d <span class="nv">id</span><span class="o">=</span>1234 -d <span class="nv">status</span><span class="o">=</span>disabled http://localhost:1664/api/v1/investigator/update/</code></pre>
        </section>
        <section id="get-search">
            <h3>1.9   GET /search</h3>
            <ul>
                <li>Description: search for actions, commands, agents or investigators.</li>
                <li>
                    <dl>
                        <dt>Parameters:</dt>
                        <dd>
                            <ul>
                                <li>
                                    <p><cite>type</cite>: define the type of item returned by the search. Valid types are: <cite>action</cite>, <cite>command</cite>, <cite>agent</cite> or <cite>investigator</cite>.</p>
                                    <blockquote>
                                        <ul>
                                            <li><cite>action</cite>: (default) return a list of actions</li>
                                            <li><cite>command</cite>: return a list of commands</li>
                                            <li><cite>agent</cite>: return a list of agents that have shown activity</li>
                                            <li><cite>investigator</cite>: return a list of investigators that have show activity</li>
                                        </ul>
                                    </blockquote>
                                </li>
                                <li><cite>actionid</cite>: filter results on numeric action ID</li>
                                <li><cite>actionname</cite>: filter results on string action name, accept <cite>ILIKE</cite> pattern</li>
                                <li>
                                    <p><cite>after</cite>: return results recorded after this RFC3339 date, depends on type:</p>
                                    <blockquote>
                                        <ul>
                                            <li><cite>action</cite>: select actions with a <cite>validfrom</cite> date greater than <cite>after</cite>. Default is last 7 days.</li>
                                            <li><cite>agent</cite>: select agents that have sent a heartbeat since <cite>after</cite>. Default is last 7 days.</li>
                                            <li><cite>command</cite>: select commands with a <cite>starttime</cite> date greated than <cite>after</cite>. Default is last 7 days.</li>
                                            <li><cite>investigator</cite>: select investigators with a <cite>createdat</cite> date greater than <cite>after</cite>. Default is last 1,000 years.</li>
                                        </ul>
                                    </blockquote>
                                </li>
                                <li><cite>agentid</cite>: filter results on the agent ID</li>
                                <li><cite>agentname</cite>: filter results on string agent name, accept <cite>ILIKE</cite> pattern</li>
                                <li>
                                    <p><cite>before</cite>: return results recorded before this RFC3339 date. If not defined, default is to retrieve results until now.</p>
                                    <blockquote>
                                        <ul>
                                            <li><cite>action</cite>: select actions with a <cite>expireafter</cite> date lower than <cite>before</cite></li>
                                            <li><cite>agent</cite>: select agents that have sent a heartbeat priot to <cite>before</cite></li>
                                            <li><cite>command</cite>: select commands with a <cite>starttime</cite> date lower than <cite>before</cite></li>
                                            <li><cite>investigator</cite>: select investigators with a <cite>lastmodified</cite> date lower than <cite>before</cite></li>
                                        </ul>
                                    </blockquote>
                                </li>
                                <li><cite>commandid</cite>: filter results on the command ID</li>
                                <li><cite>foundanything</cite>: filter commands on the <cite>foundanything</cite> boolean of their results (only for type <cite>command</cite>, as it requires looking into results)</li>
                                <li><cite>investigatorid</cite>: filter results on the investigator ID</li>
                                <li><cite>investigatorname</cite>: filter results on string investigator name, accept <cite>ILIKE</cite> pattern</li>
                                <li><cite>limit</cite>: limit the number of results to 10,000 by default</li>
                                <li><cite>report</cite>: if set, return results in the given report format (see <strong>compliance items</strong> below)</li>
                                <li>
                                    <p><cite>status</cite>: filter on internal status, accept <cite>ILIKE</cite> pattern. Status depends on the type. Below are the available statuses per type:</p>
                                    <blockquote>
                                        <ul>
                                            <li><cite>action</cite>: init, preparing, invalid, inflight, completed</li>
                                            <li><cite>agent</cite>: heartbeating, upgraded, destroyed, inactive</li>
                                            <li><cite>command</cite>: prepared, sent, success, timeout, cancelled, expired, failed</li>
                                            <li><cite>investigator</cite>: active, disabled</li>
                                        </ul>
                                    </blockquote>
                                </li>
                                <li><cite>threatfamily</cite>: filter results of the threat family of the action, accept <cite>ILIKE</cite> pattern (only for types <cite>command</cite> and <cite>action</cite>)</li>
                            </ul>
                        </dd>
                    </dl>
                </li>
            </ul>
            <p><strong>`ILIKE` pattern</strong></p>
            <p>Some search parameters accept Postgres's pattern matching syntax. For these parameters, the value is used as a SQL <cite>ILIKE</cite> search pattern, as described in <a href="http://www.postgresql.org/docs/9.4/static/functions-matching.html">Postgres's documentation</a>.</p>
            <p>Note: URL encoding transform the <strong>%</strong> character into <strong>%25</strong>, its ASCII value.</p>
            <ul>
                <li>Examples:</li>
            </ul>
            <p>Generate a compliance report from <cite>compliance</cite> action ran over the last 24 hours. For more information on the <cite>compliance</cite> format, see section 2.</p>
            <pre><code class="bash">/api/v1/search?type<span class="o">=</span><span class="nb">command</span>&amp;threatfamily<span class="o">=</span>compliance&amp;status<span class="o">=</span><span class="k">done</span>
&amp;report<span class="o">=</span>complianceitems&amp;limit<span class="o">=</span>100000
&amp;after<span class="o">=</span>2014-05-30T00:00:00-04:00&amp;before<span class="o">=</span>2014-05-30T23:59:59-04:00</code></pre>
            <p>List the agents that have sent a heartbeat in the last hour.</p>
            <pre><code class="bash">/api/v1/search?type<span class="o">=</span>agent&amp;after<span class="o">=</span>2014-05-30T15:00:00-04:00&amp;limit<span class="o">=</span>200</code></pre>
            <p>Find actions ran between two dates (limited to 10 results as is the default).</p>
            <pre><code class="bash">/api/v1/search?type<span class="o">=</span>action&amp;status<span class="o">=</span>sent
&amp;after<span class="o">=</span>2014-05-01T00:00:00-00:00&amp;before<span class="o">=</span>2014-05-30T00:00:00-00:00</code></pre>
            <p>Find the last 10 commands signed by an investigator identified by name.</p>
            <pre><code class="bash">/api/v1/search?investigatorname<span class="o">=</span>%25bob%25smith%25&amp;limit<span class="o">=</span>10&amp;type<span class="o">=</span><span class="nb">command</span></code></pre>
        </section>
    </section>
    <section id="data-transformation">
        <h2>2   Data transformation</h2>
        <p>The API implements several data transformation functions between the base format of <cite>action</cite> and <cite>command</cite>, and reporting formats.</p>
        <section id="compliance-items">
            <h3>2.1   Compliance Items</h3>
            <p>The compliance item format is used to measure the compliance of a target with particular requirement. A single compliance item represent the compliance of one target (host) with one check (test + value).</p>
            <p>In MIG, an <cite>action</cite> can contain compliance checks. An <cite>action</cite> creates one <cite>command</cite> per <cite>agent</cite>. Upon completion, the agent stores the results in the <cite>command.results</cite>. To visualize the results of an action, an investigator must look at the results of each command generated by that action.</p>
            <p>To generate compliance items, the API takes the results from commands, and creates one item per result. Therefore, a single action that creates hundreds of commands could, in turn, generate thousands of compliance items.</p>
            <p>The format for compliance items is simple, to be easily graphed and aggregated.</p>
            <pre><code class="javascript"><span class="p">{</span>
    <span class="s2">"target"</span><span class="o">:</span> <span class="s2">"agents.name='server1.prod.example.net'"</span><span class="p">,</span>
    <span class="s2">"policy"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"level"</span><span class="o">:</span> <span class="s2">"medium"</span><span class="p">,</span>
        <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"system"</span><span class="p">,</span>
        <span class="s2">"url"</span><span class="o">:</span> <span class="s2">"https://link.to.compliance.reference/index.html"</span>
    <span class="p">},</span>
    <span class="s2">"check"</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">"description"</span><span class="o">:</span> <span class="s2">"compliance check for openssh"</span><span class="p">,</span>
        <span class="s2">"location"</span><span class="o">:</span> <span class="s2">"/etc/ssh/sshd_config"</span><span class="p">,</span>
        <span class="s2">"name"</span><span class="o">:</span> <span class="s2">"check for verbose logging (logs fingerprints)"</span><span class="p">,</span>
        <span class="s2">"test"</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="o">:</span> <span class="s2">"regex"</span><span class="p">,</span>
            <span class="s2">"value"</span><span class="o">:</span> <span class="s2">"(?i)^loglevel verbose$"</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"compliance"</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="s2">"link"</span><span class="o">:</span> <span class="s2">"http://localhost:1664/api/v1/command?commandid=6019232265601776819"</span><span class="p">,</span>
    <span class="s2">"timestamp"</span><span class="o">:</span> <span class="s2">"2014-05-30T14:55:41.907745Z"</span>
<span class="p">}</span></code></pre>
            <p>When using the parameter <cite>&amp;report=complianceitems</cite>, the <cite>search</cite> endpoint of the API will generate a list of compliance items from the results of the search.</p>
        </section>
    </section>
</body>
</html>